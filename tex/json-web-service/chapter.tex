\chapter {JSON веб-сервис}\label{chap:json_web_service}

Давайте создадим простой веб-сервис: он будет принимать запрос в формате JSON и
в нём же отдавать ответ. Мы напишем сервер на WAI/Warp, а клиент~--- с помощью
{http-conduit}. Мы будем использовать \texttt{aeson} для разбора JSON и его
отображения. Мы также могли бы написать сервер и на Yesod, но для такого
простого примера большие возможности Yesod немногое нам дают.

\section {Сервер}

WAI использует пакет \texttt{conduit}, чтобы обрабатывать тела потоковых
запросов, и эффективно формирует ответы при помощи \texttt{blaze-builder}.
\texttt{aeson} использует \texttt{attoparsec} для разбора текста; используя
\texttt{attoparsec-conduit} мы получаем простое взаимодействие с WAI. В итоге
код выглядит следующим образом:

\includecode{20/server.hs}

\section {Клиент}

\texttt{http-conduit} был написан как сопутствующий компонент к WAI. Он также
использует \texttt{conduit} и~\texttt{blaze-builder} повсеместно, что означает,
что мы также получаем простое взаимодействие с~\texttt{aeson}. Несколько
комментариев для тех, кто ещё не знаком с \texttt{http-conduit}:

\begin{itemize}
  \item \lstinline'Manager' управляет открытыми соединениями таким образом, что
      повторные запросы к тому же серверу используют то же самое соединение.
      Чаще всего вам потребуется использовать функцию~\lstinline'withManager'
      для создания и очистки \lstinline!Manager!, потому как она безопасна по
      отношению к исключениям.

  \item Нам необходимо знать размер тела запроса, который мы не можем
      определить напрямую из~\lstinline'Builder'. Вместо этого мы преобразуем
      \lstinline'Builder' к ленивому \lstinline'ByteString' и берём размер из
      него.

  \item Есть несколько различных функций для инициализации запроса. Мы
      используем \lstinline'http', которая позволяет нам получать прямой доступ
      к потоку данных. Есть и другие, более высокоуровневые функции (например,
      \lstinline'httpLbs'), которые позволяют игнорировать вопросы с
      источниками и дают возможность получить напрямую тело целиком.
\end{itemize}

\includecode{20/client.hs}
